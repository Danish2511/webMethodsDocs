<!DOCTYPE html ><html xml:lang="en" lang="en" data-highlight-require-whitespace="true" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="shortcut icon" href="favicon.ico" type="image/x-icon" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><title>Using the Prefetch API</title><link rel="Prev" href="co-durable_usage.html" title="Previous" /><link rel="Next" href="co-durable_event_browsing.html" title="Next" /><link rel="StyleSheet" href="css/_universal_messaging_docset_reverb_diba2.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/social.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" /><!--[if IE 7]><link rel="StyleSheet" href="css/_universal_messaging_docset_reverb_diba2_IE7.css" type="text/css" media="all" /><![endif]--><link rel="StyleSheet" href="css/print.css" type="text/css" media="print" /><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if ((window === window.top) && (window.navigator.userAgent.indexOf('bot/') === -1)) {
        // Redirect
        //
        redirect_url = "../index.html#page/num-webhelp/co-durable_using_the_prefetch_api.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></head><body id="py34248d1_002bnISlLIOzZGcYA" class="ww_skin_page_body" onload="Page.OnLoad('../index.html#page/num-webhelp/co-durable_using_the_prefetch_api.html');"><header id="wwconnect_header"><!-- Produkt Name und Version in Breadcrumbs SQ --><div class="ww_skin_breadcrumbs"><span>Universal Messaging</span>&nbsp;10.15 |
		     <span class="ww_skin_breadcrumbs_parent"><a href="../num-webhelp/to-title_concepts.html#wwconnect_header">Concepts</a></span><span class="ww_skin_breadcrumbs_divider"> | </span><span class="ww_skin_breadcrumbs_parent"><a href="../num-webhelp/to-title_durable_subscriptions.html#wwconnect_header">Durable Subscriptions</a></span><span class="ww_skin_breadcrumbs_divider"> | </span><span class="ww_skin_breadcrumbs_current">Using the Prefetch API</span></div><div class="ww_skin_page_toolbar"><a class="ww_behavior_print ww_skin ww_skin_print" title="Print" href="#">&nbsp;</a></div></header><div id="wwID0EN22O" class="Heading_2">Using the Prefetch API</div><div id="wwID0E322O" class="Section_Title">Overview</div><div id="wwID0EB32O" class="Body">For better user experience with the Universal Messaging synchronous messaging APIs, a new set of synchronous consumer prefetch APIs were added in v10.7. The old "non-prefetch" APIs had the following disadvantages:</div><div id="wwID0EK32O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The maximum number of events which can be read from the server was limited by the Window Size setting. The window size defines the maximum number of events that have been sent to consumer but have not yet been acknowledged by the consumer. The value of the window size was not transparent for the consumer and it could not be changed dynamically. This meant that if event acknowledgment was slower than synchronous consumption, synchronous consumers would throw an exception "Need to Commit or rollback" when the window size was reached.</div><div id="wwID0E232O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Events were cached-client side. Often, events were delivered to consumers in batches, but only one event was returned by the synchronous APIs. This left some pending cached events client-side, and this situation was not transparent for the user.</div><div id="wwID0EN42O" class="Body">The prefetch APIs were created to address the above issues:</div><div id="wwID0EW42O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The synchronous APIs can now receive prefetch events which they requested and will not be limited by a window size. The client application is now in control of how many pending/unacknowledged events it can hold.</div><div id="wwID0EH52O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The APIs now return a list of events which eliminates the caching client-side and makes event delivery transparent for the consumer.</div><div id="wwID0EZ52O" class="Body">The old deprecated APIs that did not use prefetch are limited to have a prefetch of '1'. This means they cannot receive events in batches as they did before.</div><div id="wwID0E552O" class="Body">Window size is still in use for asynchronous consumers where the consumer is not in control of how many events will be received, thus here the window size makes sense to throttle the number of events sent.</div><div id="wwID0EL62O" class="Section_Title">Added Prefetch APIs</div><div id="wwID0EQ62O" class="Body">The list of prefetch APIs added in v10.7 is as follows:</div><div id="wwID0EV62O" class="Body"><span class="Bold"> Java</span></div><div id="wwID0EEA3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold">nChannelIterator:</span></div><div id="wwID0EZA3O" class="Preformatted_1">public List&lt;nConsumeEvent&gt; getNextEvents (int prefetchSize)<br />public List&lt;nConsumeEvent&gt; getNextEvents (int prefetchSize, long timeout)<br /></div><div id="wwID0EAB3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold"> nQueueSyncReader: </span></div><div id="wwID0EWB3O" class="Preformatted_1">public List&lt;nConsumeEvent&gt; popEvents (int prefetchSize)<br />public List&lt;nConsumeEvent&gt; popEvents (int prefetchSize, long timeout)<br />public List&lt;nConsumeEvent&gt; popEvents (int prefetchSize, long timeout, String selector)<br /></div><div id="wwID0E4B3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold"> MessageConsumerImpl: </span></div><div id="wwID0ETC3O" class="Preformatted_1">public List&lt;javax.jms.Message&gt; receiveMessages (int prefetchSize)<br />public List&lt;javax.jms.Message&gt; receiveMessages (long timeOut, int prefetchSize)</div><div id="wwID0E2C3O" class="Body"><span class="Bold"> C#</span></div><div id="wwID0EKD3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold">nChannelIterator: </span></div><div id="wwID0E6D3O" class="Preformatted_1">public List&lt;nConsumeEvent&gt; getNextEvents(int prefetchSize)<br />public List&lt;nConsumeEvent&gt; getNextEvents(int prefetchSize, long timeout)<br /></div><div id="wwID0EGE3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold">nQueueSyncReader: </span></div><div id="wwID0E3E3O" class="Preformatted_1">public List&lt;nConsumeEvent&gt; popEvents(int prefetchSize)<br />public List&lt;nConsumeEvent&gt; popEvents(int prefetchSize, long timeout)<br />public List&lt;nConsumeEvent&gt; popEvents(int prefetchSize, long timeout, String selector)<br /></div><div id="wwID0EEF3O" class="Body"><span class="Bold"> C++</span></div><div id="wwID0ETF3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold">nChannelIterator: </span></div><div id="wwID0EIG3O" class="Preformatted_1">std::list&lt;nConsumeEvent*&gt;* getNextEvents(int prefetchSize)<br />std::list&lt;nConsumeEvent*&gt;* getNextEvents(int prefetchSize, long timeout)<br /></div><div id="wwID0EPG3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold"> nQueueSyncReader: </span></div><div id="wwID0EFH3O" class="Preformatted_1">std::list&lt;nConsumeEvent*&gt;* popEvents(int prefetchSize)<br />std::list&lt;nConsumeEvent*&gt;* popEvents(int prefetchSize, longlong timeout)<br />std::list&lt;nConsumeEvent*&gt;* popEvents(int prefetchSize, longlong timeout, std::string selector)<br /></div><div id="wwID0EVH3O" class="Section_Title">Deprecated Prefetch APIs</div><div id="wwID0E1H3O" class="Body">The APIs deprecated in v10.7 are:</div><div id="wwID0EDI3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold">nChannel: </span></div><div id="wwID0EYI3O" class="Preformatted_1">public nChannelIterator createIterator(nDurable name, String selector, int windowSize)<br />public nChannelIterator createIterator(nDurable name, String selector, int windowSize, boolean autoAck)<br /></div><div id="wwID0E6I3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold">nChannelIterator: </span></div><div id="wwID0EUJ3O" class="Preformatted_1">public nConsumeEvent getNext()<br />public nConsumeEvent getNext(long timeout)<br /></div><div id="wwID0E2J3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span><span class="Bold">nQueueSyncReader:</span></div><div id="wwID0ERK3O" class="Preformatted_1">public final nConsumeEvent pop()<br />public final nConsumeEvent pop(final long timeout)<br />public nConsumeEvent pop(final long timeout, final String selector)<br /></div><div id="wwID0EBL3O" class="Section_Title">Horizontal Scalability (HS) Notes</div><div id="wwID0EGL3O" class="Body">Within the HS use case it is possible that the returned set of events is bigger than the requested prefetch size. The size can be the size of a previous prefetch value.</div><div id="wwID0ELL3O" class="Body">The HS mechanism sends the requests to every server in the HS landscape, and delivers the fastest response to the client. Thus if a previous request was done with a bigger prefetch value, a subsequent receive/pop call can actually receive a set of events which was requested with the bigger prefetch value and thus will be returned at once to avoid caching client-side.</div><div id="wwID0EQL3O" class="Body">A prefetch call in HS can return only events from one server. Currently the returned event set will not mix events from different servers.</div><div id="wwID0EVL3O" class="Body">For example, if we have a 3-server HS landscape and an HS channel with 100 events on each server. An iterator calls <span class="codeph">getNext</span> with a prefetch size of 5. We receive 3 responses with 5 events in each, and we deliver the first response to the client and the other 2 responses are kept waiting in the HS layer. If now a subsequent <span class="codeph">getNext</span> is called with prefetch size of 2, we deliver the cached response which has 5 events.</div><div id="wwID0ELM3O" class="Section_Title">Performance Notes</div><div id="wwID0EFN3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Using a bigger prefetch size can improve performance</div><div id="wwID0EXN3O" class="List_1_Continued">Using a bigger prefetch size can improve performance as events will be delivered in batches (if there are events piled up on the server), especially for small events. There is no upper limit or the prefetch size, but there is a limit of 1MB for each batch. Performance-wise there is no benefit of using batches bigger than 1MB.</div><div id="wwID0EOO3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>JMS API</div><div id="wwID0EAP3O" class="List_1_Continued">The prefetch functionality is not part of the JMS spec, and therefore JMS clients cannot take advantage of the prefetch functionality right away. By default, the JMS API uses a prefetch size of 1 to avoid caching client-side. Nevertheless, to allow users to consume events in batches to improve performance, the system configuration property <span class="parmname">nirvana.syncPrefetchSize</span> can be set client-side. This integer value property defines how many events the JMS synchronous consumer should request from the server (prefetch logic is the same). While the consumer will still get a single event from the receive call, the rest of the prefetch will be cached, so the client has the control over the cache, and also the same (or better) performance.</div><div id="wwID0ELP3O" class="List_1_Continued">After 10.7 Fix 1 this prefetch size for JMS can be set per Connection Factory using the connection factory property <span class="parmname">JMS_my-channels_SyncPrefetchSize</span>.</div><div id="wwID0EIQ3O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Using the prefetch APIs moves the responsibility for consumer event throttling to the client application; the server will no longer honor any window size. This needs to be taken into an account when upgrading synchronous consumer applications to version 10.7 and higher.</div><div id="wwID0EER3O" class="Section_Title">Older Clients Working with a 10.7+ Server</div><div id="wwID0EJR3O" class="Body">While the new synchronous clients will not be using a window size, clients from before the introduction of the prefetch feature will still be doing so. The new server will honor the window size (and the 10.5 queue batching) for older clients. This was done to preserve the behavior of old client applications until they can be migrated.</div><footer><!-- Related Topics --><!--                --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><!-- SQ insert Footer --><br /><hr style="border:1px solid; border-color: #1776BF; " /><!-- FRWE: Why is the font family information hard-coded?? --><div style="font-family: 'Roboto', Sans-Serif; font-size: 10px; margin-top: 6px; margin-bottom: 6px; text-align: center;"><a href="http://www.softwareag.com/licenses">Copyright © 2013-2022&nbsp;Software AG, Darmstadt, Germany and/or Software AG USA, Inc., Reston, VA, USA, and/or its subsidiaries and/or its affiliates and/or their licensors</a></div><!-- SQ insert Date 
	 <div style="text-align: center; font-weight: bold;" wwpage:content="pub-date">January 1, 2015</div> --><!-- old Footer 2016
	  <div class="footer">Copyright &#169; <span wwpage:content="sag:product-copyrfirst"></span>, <span wwpage:content="sag:organization-copyrholder"></span>, <a href="http://sag.com/" wwpage:attribute-href="sag:organization-url" wwpage:content="sag:organization-url">http://sag.com/</a>
   --><!-- SQ Variablen --><!-- Copyright Test --><!--	  <div style="text-decoration: underline">Copyright Import Test:</div>
	  <wwpage:Import wwpage:content-from-file="Copyright/copyright_en.asp" />
	  <br></br>--><!--
	  <!-\- SQ Variables - Information from xresources -\->
	  <div style="text-decoration: underline">From xresources:</div>
	  <div>sag:organization-id == <span wwpage:content="sag:organization-id"></span></div>
	  <div>sag:organization-name == <span wwpage:content="sag:organization-name"></span></div>
	  <div>sag:organization-copyrholder == <span wwpage:content="sag:organization-copyrholder"></span></div>
	  <div>sag:organization-url == <span wwpage:content="sag:organization-url"></span></div>
	  
	  <div>sag:family-id == <span wwpage:content="sag:family-id"></span></div>
	  <div>sag:family-name == <span wwpage:content="sag:family-name"></span></div>
	  <div>sag:family-organization == <span wwpage:content="sag:family-organization"></span></div>
	  
	  <div>sag:product-id == <span wwpage:content="sag:product-id"></span></div>
	  <div>sag:product-name == <span wwpage:content="sag:product-name"></span></div>
	  <div>sag:product-copyrfirst == <span wwpage:content="sag:product-copyrfirst"></span></div>
	  <div>sag:product-family == <span wwpage:content="sag:product-family"></span></div>
	  
	  <!-\- SQ Variables - Values from DITA-Map and Keymap-\->
	  <br></br>
	  <div style="text-decoration: underline">From DITA/Book-Map:</div>
	  <div>ProdInfo Prodname == <span wwpage:replace="wwvars:ProdInfoProdName"></span></div>
	  <div>ProdInfo Mod First == <span wwpage:replace="wwvars:ProdInfoModFirst"></span></div>
	  <div>ProdInfo Mod Last == <span wwpage:replace="wwvars:ProdInfoModLast"></span></div>
	  <div>ProdInfo Rel First == <span wwpage:replace="wwvars:ProdInfoRelFirst"></span></div>
	  <div>ProdInfo Rel Last == <span wwpage:replace="wwvars:ProdInfoRelLast"></span></div>
	  <div>ProdInfo Vers First == <span wwpage:replace="wwvars:ProdInfoVersFirst"></span></div>
	  <div>ProdInfo Vers Last == <span wwpage:replace="wwvars:ProdInfoVersLast"></span></div>
	  <div>ProdInfo vrm vers.rel.mod == <span wwpage:replace="wwvars:ProdInfoVersFirst"></span>.<span wwpage:replace="wwvars:ProdInfoRelLast"></span>.<span wwpage:replace="wwvars:ProdInfoModLast"></span></div>
	  <div>BookID PartNo == <span wwpage:replace="wwvars:BookPartNo"></span></div>
	  <div>othermeta release-version == <span wwpage:replace="wwvars:ReleaseVersion"></span></div>
	  <div>othermeta release-date == <span wwpage:replace="wwvars:ReleaseDate"></span></div>
	  <div>othermeta release-edition == <span wwpage:replace="wwvars:ReleaseEdition"></span></div>
	  <div>othermeta product == <span wwpage:replace="wwvars:Product"></span></div>
	  <br></br>
	  <div style="text-decoration: underline">From x_runtime/keymap.ditamap:</div>
	  <div>sag:product-shortname == <span wwpage:replace="wwvars:sag:product-shortname"></span></div>
	  <div>sag:product-longname == <span wwpage:replace="wwvars:sag:product-longname"></span></div>
	  <div>versionAdd == <span wwpage:replace="wwvars:versionAdd"></span></div>
	  <div>yearFYLY == <span wwpage:replace="wwvars:yearFYLY"></span></div>
	  <div>fingerprint == <span wwpage:replace="wwvars:fingerprint"></span></div>
	  <div>sag:CopyrightDeclaration == <span wwpage:replace="wwvars:sag:CopyrightDeclaration"></span></div>
	  <div>pdfReleaseDate == <span wwpage:replace="wwvars:pdfReleaseDate"></span></div>
	  <div>documentID == <span wwpage:replace="wwvars:documentID"></span></div>
	  <br></br>
	  <div style="text-decoration: underline">Reserve:</div>
	  <div>organization == <span wwpage:content="organization"></span></div>
	  <div>product-name == <span wwpage:content="product-name"></span></div>
	  <div>copyright-first == <span wwpage:content="copyright-first"></span></div>
	  <div>copyright-last == <span wwpage:content="copyright-last"></span></div>
	  <div>copyright-first-b == <span wwpage:content="wwvars:copyright-first-b"></span></div>
	  <div>copyright-last-b == <span wwpage:content="copyright-last-b"></span></div>
	  <div>doc-id-one == <span wwpage:content="doc-id-one"></span></div>
	  <div>doc-id-two == <span wwpage:content="doc-id-two"></span></div>  
	  <div>Published == <span wwpage:content="pub-date"></span></div>
	  --></footer></body></html>