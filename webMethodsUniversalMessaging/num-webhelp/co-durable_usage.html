<!DOCTYPE html ><html xml:lang="en" lang="en" data-highlight-require-whitespace="true" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="shortcut icon" href="favicon.ico" type="image/x-icon" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><title>Using Durable Subscriptions with Multiple Clients</title><link rel="Prev" href="co-types_of_durable_subscription.html" title="Previous" /><link rel="Next" href="co-durable_using_the_prefetch_api.html" title="Next" /><link rel="StyleSheet" href="css/_universal_messaging_docset_reverb_diba2.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/social.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" /><!--[if IE 7]><link rel="StyleSheet" href="css/_universal_messaging_docset_reverb_diba2_IE7.css" type="text/css" media="all" /><![endif]--><link rel="StyleSheet" href="css/print.css" type="text/css" media="print" /><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if ((window === window.top) && (window.navigator.userAgent.indexOf('bot/') === -1)) {
        // Redirect
        //
        redirect_url = "../index.html#page/num-webhelp/co-durable_usage.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></head><body id="pO5ymC9fd_002ftcY0wucj_002bieqw" class="ww_skin_page_body" onload="Page.OnLoad('../index.html#page/num-webhelp/co-durable_usage.html');"><header id="wwconnect_header"><!-- Produkt Name und Version in Breadcrumbs SQ --><div class="ww_skin_breadcrumbs"><span>Universal Messaging</span>&nbsp;10.15 |
		     <span class="ww_skin_breadcrumbs_parent"><a href="../num-webhelp/to-title_concepts.html#wwconnect_header">Concepts</a></span><span class="ww_skin_breadcrumbs_divider"> | </span><span class="ww_skin_breadcrumbs_parent"><a href="../num-webhelp/to-title_durable_subscriptions.html#wwconnect_header">Durable Subscriptions</a></span><span class="ww_skin_breadcrumbs_divider"> | </span><span class="ww_skin_breadcrumbs_current">Using Durable Subscriptions with Multiple Clients</span></div><div class="ww_skin_page_toolbar"><a class="ww_behavior_print ww_skin ww_skin_print" title="Print" href="#">&nbsp;</a></div></header><div id="wwID0EPR2O" class="Heading_2">Using Durable Subscriptions with Multiple Clients</div><div id="wwID0E5R2O" class="Section_Title">Window/Prefetch Size of Shared and Serial Durable Subscriptions</div><div id="wwID0EDS2O" class="Body">The Universal Messaging client API offers the option of specifying a window size (for asynchronous clients) or prefetch size (for synchronous clients) for a shared durable subscription. The window/prefetch size can be set independently for both synchronous and asynchronous subscribers which use shared durable subscriptions. The client API contains two methods that accept the window/prefetch size as a parameter: one for creating an iterator for a channel and one for adding a new subscriber with nEventListener.</div><div id="wwID0EIS2O" class="Body">When specifying the window/prefetch size, the session is by default not auto-acknowledge. This means that when the window size is reached for an asynchronous client, the client stops receiving events. When an iterator is used with a defined prefetch size for a synchronous client, the server returns the requested number of events, and it is up to the synchronous client whether to commit or roll back or prefetch the next set of events.</div><div id="wwID0ENS2O" class="Body">If the API parameter for window size is not specified for an asynchronous subscriber, <span class="codeph">nConstants.setMaxUnackedEvents(x)</span> will be used as the default client window size, if this value has been set before subscribing with listeners. If the durable subscription is not a shared durable subscription, an <span class="codeph">nIllegalArgumentException</span> is thrown. If you specify a negative window size for this API parameter, the default value stored in the server configurations will be used instead. The default value is "ClientQueueWindow", which is available in the "Cluster Config" group.</div><div id="wwID0E2S2O" class="Body"><span class="inlinetitle">Example 1</span></div><div id="wwID0EFT2O" class="Body">You can set the size of an asynchronous client window using a method from the public nChannel API: <span class="codeph">channel.addSubscriber(nEventListener nel, nDurable name, String selector, int windowSize)</span>. A different window size can be configured for every asynchronous subscriber. Here is a simple code snippet for this:</div><div id="wwID0EPT2O" class="Preformatted">nChannelAttributes channelAttr = new nChannelAttributes("channel"); <br />nChannel channel = session.createChannel(channelAttr); <br />boolean isPersistent = true; <br />boolean isClusterWide = false; <br />int startEventId = 0; <br /><br />nDurableAttributes attr = <br />    nDurableAttributes.create(nDurableAttributes.nDurableType.Shared, <br />    "shared-durable"); <br /><br />attr.setClustered(isClusterWide); <br />attr.setStartEID(startEventId); <br /><br />nDurable sharedDurable = null; <br /><br />// Need to check first in case shared durable already exists! <br />try { <br />     sharedDurable = channels.getDurableManager().get(attr.getName()); <br />   } catch (nNameDoesNotExistException ex) { <br />     sharedDurable = channels.getDurableManager().add(attr); <br />} <br /><br /><br />nEventListener listener = new nEventListener() { <br />@Override <br />public void go(nConsumeEvent evt) { <br />System.out.println("Consumed event " + evt.getEventID()); <br />} <br />}; <br /><br />int windowSize = 4; <br />channel.addSubscriber(listener, sharedDurable, null, windowSize); </div><div id="wwID0EVT2O" class="Body"><span class="inlinetitle">Example 2</span></div><div id="wwID0E6T2O" class="Body">You can also set the prefetch size for a synchronous client when using a channel iterator. Here is an example:</div><div id="wwID0EEU2O" class="Preformatted">nSession session = nSessionFactory.create(sessionAttr); <br />session.init(); <br /><br />nChannelAttributes channelAttr = new nChannelAttributes("channel"); <br />nChannel channel = session.createChannel(channelAttr); <br />boolean isPersistent = true; <br />boolean isClusterWide = false; <br />int startEventId = 0; <br />nDurable sharedDurable = null; <br /><br />// create the shared durable <br />nDurableAttributes attr = <br />    nDurableAttributes.create(nDurableAttributes.nDurableType.Shared, <br />    "shared-durable"); <br /> <br />attr.setClustered(isClusterWide); <br />attr.setStartEID(startEventId); <br /><br />// Need to check first in case shared durable is already exist! <br />try { <br />    sharedDurable = channels.getDurableManager().get(attr.getName()); <br />    } catch (nNameDoesNotExistException ex) { <br />    sharedDurable = channels.getDurableManager().add(attr); <br />} <br /><br />int prefetchSize = 4;<br />nChannelIterator iterator = channel.createIterator(sharedDurable, null);<br />List&lt;nConsumeEvent&gt; evts = iterator.getNext(prefetchSize, timeout) </div><div id="wwID0ESU2O" class="Section_Title">Checking the number of unprocessed events on a durable</div><div id="wwID0EXU2O" class="Body">You can use the API method <span class="codeph">getDepth()</span> on <span class="codeph">nDurableNode</span> to get the number of events outstanding for a durable.</div><div id="wwID0EFV2O" class="Body">For non-shared durables this method returns an <span class="Italic">estimation</span> of the number of outstanding events. This estimation does not include unacknowledged, purged or filtered events.</div><div id="wwID0EQV2O" class="Body"><span class="inlinetitle">Example</span></div><div id="wwID0E1V2O" class="Preformatted"><br />nRealmNode realmNode = <br />    new nRealmNode(new nSessionAttributes("nsp://localhost:9000")); <br />nTopicNode topicNode = (nTopicNode) realmNode.findNode(CHANNEL_NAME); <br /><br />nDurableNode durableNode = topicNode.getDurable(DURABLE_NAME); <br />long eventCount = durableNode.getDepth(); </div><div id="wwID0EAW2O" class="Body">The number of outstanding events waiting for a commit or a rollback can be found out by:</div><div id="wwID0EFW2O" class="Preformatted">long unackedCount = durableNode.getTransactionDepth();</div><div id="wwID0ETW2O" class="Section_Title">Storage Considerations</div><div id="wwID0EYW2O" class="Body">There are some storage considerations to be aware of when using shared durable subscriptions as opposed to normal (i.e. non-shared) durable subscriptions.</div><div id="wwID0E4W2O" class="Body">When you define a shared durable subscription, Universal Messaging maintains a copy of all of the events of the durable subscription in an internal store. The copies remain in the internal store until the original events have been accessed by the consumer. The benefit for the consumer is that events are held until the consumer is ready to receive them.</div><div id="wwID0ECX2O" class="Body">If the consumer accesses the events using event filtering, some events are never selected, and therefore the copies of these events remain in the internal store. As mentioned earlier, when an event is consumed for a normal durable subscription, all earlier events are also removed; however, for a shared durable subscription, only the consumed event is removed from the store. This is by design, and can, in time, lead to Universal Messaging retaining large numbers of events that are never used. If you have made the shared durable subscription persistent, a copy of the internal store will be maintained on disk, and this disk copy will also contain copies of the events that are not used.</div><div id="wwID0EHX2O" class="Body">In order to delete messages from the internal store you can purge events from the channel that the durable subscription is created on. That purge will also flow through to the internal store.</div><div id="wwID0EMX2O" class="Body">The set of events that are copied to the internal store for a given shared durable subscription is limited according to the following rules:</div><div id="wwID0EYX2O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>When the first consumer connects to the shared durable subscription and specifies an event filter, then only events that match the filter will be copied to the internal store.</div><div id="wwID0ELY2O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>If a second consumer connects to the same shared durable subscription and also specifies an event filter, then from that time onwards, only events matching the second filter will be copied to the internal store. The first consumer receives an asynchronous exception due to the changed filter, but still uses its original filter to take events off the internal store.</div><div id="wwID0E5Y2O" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>If the second consumer specifies no event filter, the filter of the first consumer remains in effect for copying events to the internal store.</div><footer><!-- Related Topics --><!--                --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><!-- SQ insert Footer --><br /><hr style="border:1px solid; border-color: #1776BF; " /><!-- FRWE: Why is the font family information hard-coded?? --><div style="font-family: 'Roboto', Sans-Serif; font-size: 10px; margin-top: 6px; margin-bottom: 6px; text-align: center;"><a href="http://www.softwareag.com/licenses">Copyright © 2013-2022&nbsp;Software AG, Darmstadt, Germany and/or Software AG USA, Inc., Reston, VA, USA, and/or its subsidiaries and/or its affiliates and/or their licensors</a></div><!-- SQ insert Date 
	 <div style="text-align: center; font-weight: bold;" wwpage:content="pub-date">January 1, 2015</div> --><!-- old Footer 2016
	  <div class="footer">Copyright &#169; <span wwpage:content="sag:product-copyrfirst"></span>, <span wwpage:content="sag:organization-copyrholder"></span>, <a href="http://sag.com/" wwpage:attribute-href="sag:organization-url" wwpage:content="sag:organization-url">http://sag.com/</a>
   --><!-- SQ Variablen --><!-- Copyright Test --><!--	  <div style="text-decoration: underline">Copyright Import Test:</div>
	  <wwpage:Import wwpage:content-from-file="Copyright/copyright_en.asp" />
	  <br></br>--><!--
	  <!-\- SQ Variables - Information from xresources -\->
	  <div style="text-decoration: underline">From xresources:</div>
	  <div>sag:organization-id == <span wwpage:content="sag:organization-id"></span></div>
	  <div>sag:organization-name == <span wwpage:content="sag:organization-name"></span></div>
	  <div>sag:organization-copyrholder == <span wwpage:content="sag:organization-copyrholder"></span></div>
	  <div>sag:organization-url == <span wwpage:content="sag:organization-url"></span></div>
	  
	  <div>sag:family-id == <span wwpage:content="sag:family-id"></span></div>
	  <div>sag:family-name == <span wwpage:content="sag:family-name"></span></div>
	  <div>sag:family-organization == <span wwpage:content="sag:family-organization"></span></div>
	  
	  <div>sag:product-id == <span wwpage:content="sag:product-id"></span></div>
	  <div>sag:product-name == <span wwpage:content="sag:product-name"></span></div>
	  <div>sag:product-copyrfirst == <span wwpage:content="sag:product-copyrfirst"></span></div>
	  <div>sag:product-family == <span wwpage:content="sag:product-family"></span></div>
	  
	  <!-\- SQ Variables - Values from DITA-Map and Keymap-\->
	  <br></br>
	  <div style="text-decoration: underline">From DITA/Book-Map:</div>
	  <div>ProdInfo Prodname == <span wwpage:replace="wwvars:ProdInfoProdName"></span></div>
	  <div>ProdInfo Mod First == <span wwpage:replace="wwvars:ProdInfoModFirst"></span></div>
	  <div>ProdInfo Mod Last == <span wwpage:replace="wwvars:ProdInfoModLast"></span></div>
	  <div>ProdInfo Rel First == <span wwpage:replace="wwvars:ProdInfoRelFirst"></span></div>
	  <div>ProdInfo Rel Last == <span wwpage:replace="wwvars:ProdInfoRelLast"></span></div>
	  <div>ProdInfo Vers First == <span wwpage:replace="wwvars:ProdInfoVersFirst"></span></div>
	  <div>ProdInfo Vers Last == <span wwpage:replace="wwvars:ProdInfoVersLast"></span></div>
	  <div>ProdInfo vrm vers.rel.mod == <span wwpage:replace="wwvars:ProdInfoVersFirst"></span>.<span wwpage:replace="wwvars:ProdInfoRelLast"></span>.<span wwpage:replace="wwvars:ProdInfoModLast"></span></div>
	  <div>BookID PartNo == <span wwpage:replace="wwvars:BookPartNo"></span></div>
	  <div>othermeta release-version == <span wwpage:replace="wwvars:ReleaseVersion"></span></div>
	  <div>othermeta release-date == <span wwpage:replace="wwvars:ReleaseDate"></span></div>
	  <div>othermeta release-edition == <span wwpage:replace="wwvars:ReleaseEdition"></span></div>
	  <div>othermeta product == <span wwpage:replace="wwvars:Product"></span></div>
	  <br></br>
	  <div style="text-decoration: underline">From x_runtime/keymap.ditamap:</div>
	  <div>sag:product-shortname == <span wwpage:replace="wwvars:sag:product-shortname"></span></div>
	  <div>sag:product-longname == <span wwpage:replace="wwvars:sag:product-longname"></span></div>
	  <div>versionAdd == <span wwpage:replace="wwvars:versionAdd"></span></div>
	  <div>yearFYLY == <span wwpage:replace="wwvars:yearFYLY"></span></div>
	  <div>fingerprint == <span wwpage:replace="wwvars:fingerprint"></span></div>
	  <div>sag:CopyrightDeclaration == <span wwpage:replace="wwvars:sag:CopyrightDeclaration"></span></div>
	  <div>pdfReleaseDate == <span wwpage:replace="wwvars:pdfReleaseDate"></span></div>
	  <div>documentID == <span wwpage:replace="wwvars:documentID"></span></div>
	  <br></br>
	  <div style="text-decoration: underline">Reserve:</div>
	  <div>organization == <span wwpage:content="organization"></span></div>
	  <div>product-name == <span wwpage:content="product-name"></span></div>
	  <div>copyright-first == <span wwpage:content="copyright-first"></span></div>
	  <div>copyright-last == <span wwpage:content="copyright-last"></span></div>
	  <div>copyright-first-b == <span wwpage:content="wwvars:copyright-first-b"></span></div>
	  <div>copyright-last-b == <span wwpage:content="copyright-last-b"></span></div>
	  <div>doc-id-one == <span wwpage:content="doc-id-one"></span></div>
	  <div>doc-id-two == <span wwpage:content="doc-id-two"></span></div>  
	  <div>Published == <span wwpage:content="pub-date"></span></div>
	  --></footer></body></html>