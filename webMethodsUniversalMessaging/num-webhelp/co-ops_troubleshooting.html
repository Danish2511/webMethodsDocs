<!DOCTYPE html ><html xml:lang="en" lang="en" data-highlight-require-whitespace="true" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="shortcut icon" href="favicon.ico" type="image/x-icon" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><title>Troubleshooting</title><link rel="Prev" href="co-ops_logging_6.html" title="Previous" /><link rel="Next" href="co-ops_purging_archiving.html" title="Next" /><link rel="StyleSheet" href="css/_universal_messaging_docset_reverb_diba2.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/social.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" /><!--[if IE 7]><link rel="StyleSheet" href="css/_universal_messaging_docset_reverb_diba2_IE7.css" type="text/css" media="all" /><![endif]--><link rel="StyleSheet" href="css/print.css" type="text/css" media="print" /><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if ((window === window.top) && (window.navigator.userAgent.indexOf('bot/') === -1)) {
        // Redirect
        //
        redirect_url = "../index.html#page/num-webhelp/co-ops_troubleshooting.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></head><body id="pXrELDy6Yvg91WeVniM8jjg" class="ww_skin_page_body" onload="Page.OnLoad('../index.html#page/num-webhelp/co-ops_troubleshooting.html');"><header id="wwconnect_header"><!-- Produkt Name und Version in Breadcrumbs SQ --><div class="ww_skin_breadcrumbs"><span>Universal Messaging</span>&nbsp;10.15 |
		     <span class="ww_skin_breadcrumbs_parent"><a href="../num-webhelp/to-title_operations_guide.html#wwconnect_header">Operations Guide</a></span><span class="ww_skin_breadcrumbs_divider"> | </span><span class="ww_skin_breadcrumbs_current">Troubleshooting</span></div><div class="ww_skin_page_toolbar"><a class="ww_behavior_print ww_skin ww_skin_print" title="Print" href="#">&nbsp;</a></div></header><div id="wwID0EXL4W" class="Heading_1">Troubleshooting</div><div id="wwID0EGM4W" class="Section_Title">Out of Memory</div><div id="wwID0ELM4W" class="Body">One of the common reasons for a realm to attempt a graceful shutdown is an OutOfMemoryException.</div><div id="wwID0EQM4W" class="Body"><span class="Bold">Cause</span></div><div id="wwID0EAN4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The realm server is under heavy load where the current allocated maximum heap resource is not enough to handle this high load or volume.</div><div id="wwID0ETN4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Reliable channels keep all their events in memory. If the events on these reliable channels are larger (in total size) than the amount of memory available to the realm server's JVM then it will run out of memory.</div><div id="wwID0EGO4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Due to a memory leak issue in the realm server.</div><div id="wwID0E1O4W" class="Body"><span class="Bold">Solution</span></div><div id="wwID0EKP4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Consider using other channel types (for example, persistent for storing to disk)</div><div id="wwID0E4P4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Purge events from channels either programmatically or by using channel attributes such as TTL or capacity.</div><div id="wwID0EQQ4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Servers with a large number of resources and handling large message loads may legitimately need a large amount of memory to operate. If high memory usage is due to high load, one suggestion is to increase the UM maximum heap size to a higher value so Universal Messaging has enough heap to handle the load. This value can be changed in an entry called "wrapper.java.maxmemory" in Server_Common.conf (under UniversalMessaging/server/&lt;InstanceName&gt;/bin ), and then you need to restart the Universal Messaging realm.</div><div id="wwID0EWR4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>If the realm server is running on the RedHat Enterprise Linux 6 OS (RHEL 6), execute the command below to capture the output to a <span class="codeph">debug.out</span> file during the time when memory is continuing to grow:</div><div id="wwID0EMS4W" class="Preformatted_1">pmap &lt;realm_server_pid&gt; &gt; ./debug.out <br /><br />For example: <br />pmap 17845 &gt; ./debug.out</div><div id="wwID0ESS4W" class="List_1_Continued">Next, review the <span class="codeph">debug.output</span> file from the above command. If there are many of the entries with <span class="codeph">[anon]</span> as shown in the example below, this indicates the cause of the high memory usage is due to the Linux/JVM bug which has been discussed in the following articles that provide more information and a work-around solution.</div><div id="wwID0EGT4W" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>
    <a href="https://serverfault.com/questions/341579/what-consumes-memory-in-java-process"
   
     target="external_window"
    ><span class="heading-page"> https://serverfault.com/questions/341579/what-consumes-memory-in-java-process</span></a></div><div id="wwID0EBU4W" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>
    <a href="https://www.ibm.com/developerworks/community/blogs/kevgrig/entry/linux_glibc_2_10_rhel_6_malloc_may_show_excessive_virtual_memory_usage?lang=en"
   
     target="external_window"
    ><span class="heading-page"> https://www.ibm.com/developerworks/community/blogs/kevgrig/entry/linux_glibc_2_10_rhel_6_malloc_may_show_excessive_virtual_memory_usage?lang=en</span></a></div><div id="wwID0E4U4W" class="Preformatted_1">0000000000400000 4K r-x-- java0000000000600000 4K rw--- java<br />0000000002201000 4896K rw--- [ anon ] 00000005c0000000 8390912K rw--- [ anon ]<br />00000007c0240000 1046272K ----- [ anon ] 00007f6ab8000000 27108K rw--- [ anon ]<br />00007f6ab9a79000 38428K ----- [ anon ] 00007f6ac8000000 65492K rw--- [ anon ]<br />00007f6acbff5000 44K ----- [ anon ]</div><div id="wwID0EDV4W" class="List_1_Continued">If the cause of high memory is due to JVM/Linux as described above, the system variable <span class="codeph">MALLOC_ARENA_MAX</span> on the OS needs to be reviewed and adjusted to correct this issue. A suggestion is to set <span class="codeph">MALLOC_ARENA_MAX=1</span> as a work-around to correct this growing memory.</div><div id="wwID0ETV4W" class="Body"><span class="Bold">Mitigation</span></div><div id="wwID0E2W4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Monitor the realm server's JVM heap memory usage and take corrective actions.</div><div id="wwID0EOX4W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The following information needs to be gathered apart from the regular details, if further root cause analysis is needed:</div><div id="wwID0EZY4W" class="Numbered_2"><span class="WebWorks_Number" style="width: 18pt"><span>1. </span></span>Execute a pmap command as below to capture the output</div><div id="wwID0ELZ4W" class="Preformatted_2">pmap &lt;realm_server_pid&gt; &gt; ./debug.out <br /><br />For example: pmap 17845 &gt; ./debug.out</div><div id="wwID0EF14W" class="Numbered_2"><span class="WebWorks_Number" style="width: 18pt"><span>2. </span></span>Take the heap dump of the realm server during the time when memory is high. From the command line, navigate to the &lt;InstallDir&gt;/jvm/jvm/bin directory and execute the following command to generate the heap dump:</div><div id="wwID0EX14W" class="Preformatted_2">jmap -dump:format=b,file=&lt;full_path&gt;\&lt;file_name&gt;.hprof &lt;RealmServer_pid&gt;</div><div id="wwID0E414W" class="Numbered_2_Continued">For example, on Windows:</div><div id="wwID0EC24W" class="Preformatted_2">jmap -dump:format=b,file=C:\tmp\realm9300.hprof 13276</div><div id="wwID0EI24W" class="Numbered_2_Continued">Unix:</div><div id="wwID0EN24W" class="Preformatted_2">./jmap -dump:format=b,file=/temp/realm9300.hprof 13276</div><div id="wwID0EA34W" class="Section_Title">java.lang.OutOfMemoryError Direct buffer memory</div><div id="wwID0EF34W" class="Body">There is a case where the realm server will shut down when the direct memory configuration is not sufficient for the realm server to use while handling the load or transactions.</div><div id="wwID0EI44W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>1. </span></span>Review the nirvana.log file (under the &lt;DataDir&gt; directory) and verify to see if there is an error such as <span class="codeph">"java.lang.OutOfMemoryError Direct buffer Memory"</span> before the realm server went down, for example:</div><div id="wwID0E544W" class="Preformatted_1">[Tue Jul 25 12:20:07 PDT 2017],UserManager: User abc@&lt;host&gt;<br />Logged Out using nsp, Reason : java.lang.OutOfMemoryError Direct buffer memory,<br />session established for 26192 seconds, Session Id = 3c7fd6a000000000 ID:<br />&lt;host&gt;:37532</div><div id="wwID0EY54W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>2. </span></span>Verify the realm configuration to see whether realm server is configured for use with direct buffering or heap buffering, since this issue only happens when the realm server is configured to use direct buffering. From Enterprise Manager, under the "Config" tab, navigate to "Connection Config", and check "UseDirectBuffering". If it set to "true", this means the realm server will allocate DirectByteBuffers to use for network I/O (otherwise the realm server will use HeapByteBuffers instead).</div><div id="wwID0EK64W" class="Numbered_1_Continued">If "UseDirectBuffering" is set to true, and the realm server stopped with the above error in nirvana.log, this indicates there are two possibilities that can cause this issue:</div><div id="wwID0ENA5W" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The available direct memory which is allocated for this server is not sufficient.</div><div id="wwID0ETB5W" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Or, the direct memory is sufficient, however the garbage collection (GC) does not run frequently enough to free the memory.</div><div id="wwID0E3C5W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>3. </span></span>Next, to find out how much memory is currently allocate for Direct Memory, open Server_Common.conf (under &lt;InstallDir&gt;/UniversalMessaging/server/&lt;InstanceName&gt;/bin ) and check the current value of "MaxDirectoryMemorySize". For example, the following entry sets the size to 1 gigabyte:</div><div id="wwID0EOD5W" class="Preformatted_1">wrapper.java.additional.17=-XX:MaxDirectMemorySize=1G</div><div id="wwID0EIE5W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>4. </span></span>To monitor the buffer usage, from Enterprise Manager, navigate to the "Monitoring" &gt; "Threads" &gt; "Pools" tab, then monitor the "Buffers Created" and "Buffers Reused" values to get a better idea of the buffer usage.</div><div id="wwID0E4E5W" class="Body"><span class="Bold">Cause</span></div><div id="wwID0EFG5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Direct memory configuration is not sufficient for the realm server to use while handling the load or transactions.</div><div id="wwID0E1G5W" class="Body"><span class="Bold">Solution</span></div><div id="wwID0EEH5W" class="Body">There are three suggested options that can be used to resolve this issue depending on the customer's environment, configuration, and architecture.</div><div id="wwID0EHI5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Increase the value for MaxDirectMemorySize (configured in Server_Common.conf ) as long as there is enough memory (RAM) available on the system.</div><div id="wwID0ENJ5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Or, decrease the maximum heap memory setting (wrapper.java.maxmemory in Server_Common.conf). This will cause more frequent GC sweeps so it can release the allocated direct memory.</div><div id="wwID0EAK5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Or, disable to use of direct memory. This can be done by setting "Config" &gt; "Connection Config" &gt; "UseDirectBuffering"=false in the Enterprise Manager.</div><div id="wwID0ETK5W" class="Note_1"><span class="Bold">Note:<br /></span>This will adversely affect the performance of the UM to some extent. It also requires to increase the max heap size. The heap size should be at least equal to the current heap size plus the direct memory size.</div><div id="wwID0EML5W" class="Body"><span class="Bold">Mitigation</span></div><div id="wwID0EPM5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Monitor the memory usage of the realm server process and take corrective action.</div><div id="wwID0ECN5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The following information needs to be gathered apart from the regular details, if further root cause analysis is needed:</div><div id="wwID0ETO5W" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The buffer usage from Enterprise Manager. Navigate to the tab "Monitoring" &gt; "Threads" &gt; "Pools", then monitor the "Buffers Created" and "Buffers Reused" values to get a better idea of the buffer usage.</div><div id="wwID0ESP5W" class="Section_Title">Too many open files</div><div id="wwID0EXP5W" class="Body">The realm server can shut down due to an environment error, data/RealmSpecific/channels.nst_new (Too many open files).</div><div id="wwID0E3P5W" class="Body"><span class="Bold">Cause</span></div><div id="wwID0EER5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The realm server has exceeded the maximum file descriptors limit on the operating system.</div><div id="wwID0EZR5W" class="Body"><span class="Bold">Solution</span></div><div id="wwID0EBT5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Increase the ulimit values based on the following requirements</div><div id="wwID0ELU5W" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>~2 socket connection per client</div><div id="wwID0ERV5W" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>1 per channel or queue</div><div id="wwID0EXW5W" class="List_2"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>~30 for realm server state synchronization</div><div id="wwID0EPX5W" class="Body"><span class="Bold">Mitigation</span></div><div id="wwID0EXY5W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Set appropriate ulimit values based on the number of clients, channels/queues</div><div id="wwID0EUZ5W" class="Section_Title">Cluster Not Forming</div><div id="wwID0EZZ5W" class="Body"><span class="Bold">Cause</span></div><div id="wwID0EB25W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The cluster cannot form if more than 50% of the realm servers forming the cluster are unavailable or not reachable</div><div id="wwID0EH35W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Inter-realm server communication or network is broken</div><div id="wwID0E335W" class="Body"><span class="Bold">Solution</span></div><div id="wwID0EE55W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Make sure that at least 2 realm servers in a 3 node cluster are online and reachable</div><div id="wwID0EK65W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Make sure that all the realm servers are reachable from each other</div><div id="wwID0E665W" class="Body">Contact Software AG Technical Support if none of the above works.</div><div id="wwID0EEA6W" class="Body"><span class="Bold">Mitigation</span></div><div id="wwID0EMB6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Monitor the cluster state</div><div id="wwID0EJC6W" class="Section_Title">Realm node fails to start</div><div id="wwID0EOC6W" class="Body">The realm server uses the Tanuki Java Service wrapper to start. Behind the scenes, the Tanuki wrapper tracks the health of the JVM process by pinging it. If it does not get a response from the JVM started process within a certain preset time limit, the Tanuki wrapper throws the message <span class="codeph">"Startup failed: Timed out waiting for singal from JVM"</span>. Then, the wrapper will either try to restart the JVM process again if "Automatic JVM restarts" is enabled, or the Tanuki wrapper will issue a shutdown if "Automatic JVM Restarts" is disabled.</div><div id="wwID0ERD6W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>1. </span></span>Review UMRealmService.log : Navigate to the &lt;InstallDir&gt;/UniversalMessaging/server/&lt;InstanceName&gt;/bin directory, open UMRealmService.log and search for "Timed out waiting for signal from JVM". For example, the messages when the realm server fails to come up may look something like this:</div><div id="wwID0EDE6W" class="Preformatted_1">wrapper | Startup failed: Timed out waiting for signal from JVM.<br />wrapper | JVM did not exit on request, termination requested. <br />wrapper | JVM received a signal SIGKILL (9). <br />wrapper | JVM process is gone. <br />wrapper | JVM exited after being requested to terminate. <br />wrapper | Automatic JVM Restarts disabled. Shutting down. <br />wrapper | &lt;-- Wrapper Stopped</div><div id="wwID0E4E6W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>2. </span></span>Check Server_Common.conf under the &lt;InstallDir&gt;/UniversalMessaging/server/&lt;InstanceName&gt;/bin directory to see if the entry "wrapper.startup.timeout" exists and is set to any value. If this entry does not exist, the default value set by Tanuki is 30 seconds.</div><div id="wwID0ERF6W" class="Body"><span class="Bold">Cause</span></div><div id="wwID0E2F6W" class="Body">The realm server could not start within the timeout setting of Tanuki wrapper.</div><div id="wwID0EAG6W" class="Body">Typical causes could be:</div><div id="wwID0E5G6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Memory or CPU starvation</div><div id="wwID0EEI6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Heavy swap usage</div><div id="wwID0EYI6W" class="Body"><span class="Bold">Solution</span></div><div id="wwID0EAK6W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>1. </span></span>The quick solution is to add (if it does not exist) or update the entry in Server_Common.conf in the &lt;InstallDir&gt;/UniversalMessaging/server/&lt;InstanceName&gt;/bin directory, and set the timeout to a higher value (for example 300 seconds), then restart the realm server.</div><div id="wwID0ESK6W" class="Preformatted_1">wrapper.startup.timeout=300</div><div id="wwID0EML6W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>2. </span></span>Once the realm server is up, review nirvana.log to find out the reason for the longer startup time</div><div id="wwID0EBM6W" class="Body"><span class="Bold">Mitigation</span></div><div id="wwID0EEN6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>None</div><div id="wwID0EAO6W" class="Section_Title">Realm node fails to recover</div><div id="wwID0EFO6W" class="Body">A server which fails to recover will retry automatically and can often recover given enough time. Realms that are offline for a long time may take a long time to recover, as all information has to be re-synchronized from the master. Monitor the cluster state as noted in one of the previous sections. As long as the recovery is progressing and not looping on any particular message, the realm should be left to complete its recovery.</div><div id="wwID0EKO6W" class="Body"><span class="Bold">Cause</span></div><div id="wwID0EUO6W" class="Body">A common cause of failure to recover is data corruption. This will appear in the log files as repeated occurrences of 'Cluster recovery failed... retrying' and 'going into recovery for channel' for the same channel.</div><div id="wwID0EZO6W" class="Body">For example:</div><div id="wwID0E5O6W" class="Preformatted">[Wed Feb 18 10:20:49 EST 2017],Cluster recovery failed...retrying: <br />/cfp/core/maps/moduleHeartBeatMap First EID:540811 Last EID:541706<br />with 17 events First EID:516482 Last EID:541706 with 19 events<br />[Wed Feb 18 10:20:49 EST 2017],Going into recovery for channel<br />[/cfp/core/maps/moduleHeartBeatMap] because eid 541706 Status EID 541706<br />Channel Events: 17 Status Events:19</div><div id="wwID0EEP6W" class="Body">Storage file(s) can get corrupted for various reasons:</div><div id="wwID0ECQ6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Disk space ran out and the information cannot be stored to the file properly, or only partial information is stored which leads to corrupted information in the file(s).</div><div id="wwID0EIR6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Disk drive issues which causes the file to be damaged or not accessible.</div><div id="wwID0EOS6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Synchronization issues between storage files throughout the cluster.</div><div id="wwID0ECT6W" class="Body">For example, below are a few examples of the errors to indicate the storage file is corrupted or has some kind of problem which prevent the realm server from coming up. In the other case, the error may not be exactly the same, but if the same error with the same filename keeps repeating, this hints that the file is probably corrupted or has some issue.</div><div id="wwID0EAU6W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>1. </span></span>The following exception indicates that there is an issue with the file <span class="codeph">NirvanaClusterQueueCommitChannelb7cd0d8d1f8b5e.mem</span>, which prevents the realm server from starting:</div><div id="wwID0EWU6W" class="Preformatted_1">[Fri Apr 28 21:33:09 BST 2017],Mixed-Store&gt;<br />/UniversalMessaging/server/my_server/data/<br />  RealmSpecific/NirvanaClusterQueueCommitChannelb7cd0d8d1f8b5e.mem:<br />  Exception Follows: <br />Fri Apr 28 21:33:09 BST 2017],Socket Stream reach EOF<br />java.io.EOFException: Socket Stream reach EOF at <br />com.pcbsys.foundation.io.fEventInputStream.readComplete(fEventInputStream.java:393)<br />at com.pcbsys.foundation.io.fEventInputStream.readByteArray(fEventInputStream.java:300)<br />at com.pcbsys.nirvana.base.events.nBasePublishEvent.performRead(nBasePublishEvent.java:430)</div><div id="wwID0EQV6W" class="Numbered_1"><span class="WebWorks_Number" style="width: 18pt"><span>2. </span></span>The following messages repeat every 1 minute in the log, and this indicates that there is an issue with the file <span class="codeph">/namedsubqueues/xyz/top/um/productESB/NamedSubscriber4611686018427387905</span>, which prevents the realm server from coming up.</div><div id="wwID0EGW6W" class="Preformatted_1">[Sat Apr 22 00:38:24 BST 2017],Restarting restore for<br />/namedsubqueues/xyz/top/um/productESB/NamedSubscriber4611686018427387905 <br />[Sat Apr 22 00:38:24 BST 2017],Cluster&gt; Cluster Recovery started for<br />/namedsubqueues/xyz/top/um/productESB/NamedSubscriber4611686018427387905...<br />[Sat Apr 22 00:38:25 BST 2017],Restarting restore for<br />/namedsubqueues/xyz/top/um/productESB/NamedSubscriber4611686018427387905 <br />[Sat Apr 22 00:38:25 BST 2017],Cluster&gt; Cluster Recovery started for<br />/namedsubqueues/xyz/top/um/productESB/NamedSubscriber4611686018427387905</div><div id="wwID0EOW6W" class="Body"><span class="Bold">Solution</span></div><div id="wwID0EYW6W" class="Body">The data in the Universal Messaging channels is stored in <span class="codeph">.mem</span> files on disk, in the &lt;DataDir&gt; directory of the realm. The contents of the channel can be found in a file called <span class="codeph">&lt;channelName&gt;&lt;hashNumber&gt;.mem</span>. The hash number is internally generated and is usually not significant for our purposes.</div><div id="wwID0EGX6W" class="Body">Follow these steps for recovering from the data corruption cases</div><div id="wwID0EJY6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Stop (gracefully) the realm that is having problems recovering</div><div id="wwID0EPZ6W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Take a backup of the &lt;DataDir&gt; directory</div><div id="wwID0EV16W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Identify the .mem file for the channel on disk by the channel name</div><div id="wwID0E226W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Delete this .mem file</div><div id="wwID0EB46W" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Restart the realm</div><div id="wwID0EW46W" class="Body">The data will be re-synchronized from the master, so no data will be lost for the channel.</div><div id="wwID0E246W" class="Important"><span class="Bold">Important:<br /></span>Deleting a store erases the data from that slave node. If multiple nodes fail it may become impossible to recover data from the cluster. Always back up the contents of the data directory before performing any manual operation. Never modify the contents of the data directory while a realm is running.</div><div class="ww_skin_page_overflow"><table class="Default" cellspacing="0" summary=""><tr><td class="Table_Cell" style="border-bottom-color: Black; border-bottom-style: solid; border-bottom-width: 1px; border-left-color: Black; border-left-style: solid; border-left-width: 1px; border-right-color: Black; border-right-style: solid; border-right-width: 1px; border-top-color: Black; border-top-style: solid; border-top-width: 1px; padding-left: 2pt; padding-right: 2pt; vertical-align: top; width: 100%"><div id="wwID0EO66W" class="Table_Cell"><span class="Bold">Note:</span></div><div id="wwID0EY66W" class="Table_Cell">If there are one or more .mem files that are drastically different from the store on the master realm, recovery can take a long time, as this .mem file has to be reconciled with the master store. This case can be seen by cluster log messages showing those specific channels repeatedly in recovery over an extended period. For example multiple occurrences of messages like the following would be diagnostic:</div><div id="wwID0E466W" class="Preformatted">Cluster&gt; Still in recovery for /various/messenger/generic</div><div id="wwID0EDAAX" class="Table_Cell">For these cases removing the .mem file from a realm will cause the entire store to be synchronized from the master and will speed up recovery. Proceed as outlined above for the data corruption case.</div></td></tr></table></div><div id="wwID0ENAAX" class="Body">Contact Software AG Technical Support if none of the above works.</div><div id="wwID0ESAAX" class="Body"><span class="Bold">Mitigation</span></div><div id="wwID0E1BAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>If possible, shut down all the servers (gracefully). Killing the realm can cause data corruption and problems reforming the cluster.</div><div id="wwID0EXCAX" class="Section_Title">Realm drops out of cluster</div><div id="wwID0E3CAX" class="Body">A realm goes offline and drops out of the cluster, with the following message indicating that the keep alive pings between the realms are not being returned:</div><div id="wwID0EBDAX" class="Preformatted">nPhysicalKeepAlive : Terminating inactive cluster inter realm link<br />due to no data received</div><div id="wwID0EHDAX" class="Body">Sometimes disconnected messages appear, like:</div><div id="wwID0EMDAX" class="Preformatted">[Tue Jun 13 23:38:56 EDT 2017],Disconnected from p2um1</div><div id="wwID0ESDAX" class="Body"><span class="Bold">Cause</span></div><div id="wwID0EVEAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>This may happen because of a slow response on the remote realm(s) due to load and/or resource constraints. By default a realm sends keep alive messages every 10 seconds and will log the message if there is no response in 35 seconds. Check the log on the remote realm(s) for signs of distress, warnings, and errors.</div><div id="wwID0E2FAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Frequent GCs could result in message in <span class="codeph">UMRealmService.log</span> like below, indicating that the JVM's response is very slow.</div><div id="wwID0ERGAX" class="Preformatted_1">STATUS | wrapper | 2017/06/18 23:38:50 | <br />   Pinging the JVM took 4 seconds to respond.	</div><div id="wwID0EYGAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>The slow response of the JVM could be caused by CPU, memory, or other constraints in its environment.</div><div id="wwID0ELHAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Cases of network errors are visible as java.io errors in the log files.</div><div id="wwID0E5HAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>In the case of socket/TCP problems, UM does not always get a clear message from the Java I/O libraries on exactly what went wrong. The Java libraries will sometimes just give a generic socket exception message, which shows up as the java.io.EOFException or similar. Check on the network using network diagnostics.</div><div id="wwID0ESIAX" class="Body"><span class="Bold">Solution</span></div><div id="wwID0E3IAX" class="Body">Identify the root cause from the logs as described in the previous section and try to resolve the issue.</div><div id="wwID0EBJAX" class="Body"><span class="Bold">Mitigation</span></div><div id="wwID0ELJAX" class="Body">Monitor the network and other resources and take appropriate corrective actions before a realm server goes unresponsive and drops out of the cluster.</div><div id="wwID0EYJAX" class="Section_Title">Consumer Performance leading to "Consumer Warning" entries</div><div id="wwID0E4JAX" class="Body">In some cases, there can be "Consumer Warning" entries in the server log (logged in log level "Warning").</div><div id="wwID0ECKAX" class="Body"><span class="Bold">Cause</span></div><div id="wwID0EMKAX" class="Body">These log entries are generally related to poor performance on the consumer side. Typical symptoms are:</div><div id="wwID0EVKAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Events piling up on a queue or channel with shared or serial durables.</div><div id="wwID0EGLAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Slow consumption or publishing as a result of a consumer having incorrectly configured event filters.</div><div id="wwID0EYLAX" class="Body"><span class="Bold">Solution</span></div><div id="wwID0ECMAX" class="Body">The presence of these "Consumer Warning" log entries can give information about consumers that are not properly configured, such as:</div><div id="wwID0ELMAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Consumers which are slow in acknowledging events, which can lead to events pile up.</div><div id="wwID0E3MAX" class="List_1"><span class="WebWorks_Number" style="width: 18pt"><span><img src="chapterTOC_bullet.png" alt="*" border="0" width="10" height="10" /></span></span>Consumers with incorrectly configured filters which can affect performance or lead to events piling up.</div><div id="wwID0EONAX" class="Body">To be able to see the "Consumer Warning" log entries, the log level of the server should be set to "Warning" or more verbose.</div><div id="wwID0ETNAX" class="Body"><span class="Bold">Mitigation</span></div><div id="wwID0E4NAX" class="Body">Based on the "Consumer Warning" entries, check if your event consumption strategy can be optimized.</div><footer><!-- Related Topics --><!--                --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><!-- SQ insert Footer --><br /><hr style="border:1px solid; border-color: #1776BF; " /><!-- FRWE: Why is the font family information hard-coded?? --><div style="font-family: 'Roboto', Sans-Serif; font-size: 10px; margin-top: 6px; margin-bottom: 6px; text-align: center;"><a href="http://www.softwareag.com/licenses">Copyright Â© 2013-2022&nbsp;Software AG, Darmstadt, Germany and/or Software AG USA, Inc., Reston, VA, USA, and/or its subsidiaries and/or its affiliates and/or their licensors</a></div><!-- SQ insert Date 
	 <div style="text-align: center; font-weight: bold;" wwpage:content="pub-date">January 1, 2015</div> --><!-- old Footer 2016
	  <div class="footer">Copyright &#169; <span wwpage:content="sag:product-copyrfirst"></span>, <span wwpage:content="sag:organization-copyrholder"></span>, <a href="http://sag.com/" wwpage:attribute-href="sag:organization-url" wwpage:content="sag:organization-url">http://sag.com/</a>
   --><!-- SQ Variablen --><!-- Copyright Test --><!--	  <div style="text-decoration: underline">Copyright Import Test:</div>
	  <wwpage:Import wwpage:content-from-file="Copyright/copyright_en.asp" />
	  <br></br>--><!--
	  <!-\- SQ Variables - Information from xresources -\->
	  <div style="text-decoration: underline">From xresources:</div>
	  <div>sag:organization-id == <span wwpage:content="sag:organization-id"></span></div>
	  <div>sag:organization-name == <span wwpage:content="sag:organization-name"></span></div>
	  <div>sag:organization-copyrholder == <span wwpage:content="sag:organization-copyrholder"></span></div>
	  <div>sag:organization-url == <span wwpage:content="sag:organization-url"></span></div>
	  
	  <div>sag:family-id == <span wwpage:content="sag:family-id"></span></div>
	  <div>sag:family-name == <span wwpage:content="sag:family-name"></span></div>
	  <div>sag:family-organization == <span wwpage:content="sag:family-organization"></span></div>
	  
	  <div>sag:product-id == <span wwpage:content="sag:product-id"></span></div>
	  <div>sag:product-name == <span wwpage:content="sag:product-name"></span></div>
	  <div>sag:product-copyrfirst == <span wwpage:content="sag:product-copyrfirst"></span></div>
	  <div>sag:product-family == <span wwpage:content="sag:product-family"></span></div>
	  
	  <!-\- SQ Variables - Values from DITA-Map and Keymap-\->
	  <br></br>
	  <div style="text-decoration: underline">From DITA/Book-Map:</div>
	  <div>ProdInfo Prodname == <span wwpage:replace="wwvars:ProdInfoProdName"></span></div>
	  <div>ProdInfo Mod First == <span wwpage:replace="wwvars:ProdInfoModFirst"></span></div>
	  <div>ProdInfo Mod Last == <span wwpage:replace="wwvars:ProdInfoModLast"></span></div>
	  <div>ProdInfo Rel First == <span wwpage:replace="wwvars:ProdInfoRelFirst"></span></div>
	  <div>ProdInfo Rel Last == <span wwpage:replace="wwvars:ProdInfoRelLast"></span></div>
	  <div>ProdInfo Vers First == <span wwpage:replace="wwvars:ProdInfoVersFirst"></span></div>
	  <div>ProdInfo Vers Last == <span wwpage:replace="wwvars:ProdInfoVersLast"></span></div>
	  <div>ProdInfo vrm vers.rel.mod == <span wwpage:replace="wwvars:ProdInfoVersFirst"></span>.<span wwpage:replace="wwvars:ProdInfoRelLast"></span>.<span wwpage:replace="wwvars:ProdInfoModLast"></span></div>
	  <div>BookID PartNo == <span wwpage:replace="wwvars:BookPartNo"></span></div>
	  <div>othermeta release-version == <span wwpage:replace="wwvars:ReleaseVersion"></span></div>
	  <div>othermeta release-date == <span wwpage:replace="wwvars:ReleaseDate"></span></div>
	  <div>othermeta release-edition == <span wwpage:replace="wwvars:ReleaseEdition"></span></div>
	  <div>othermeta product == <span wwpage:replace="wwvars:Product"></span></div>
	  <br></br>
	  <div style="text-decoration: underline">From x_runtime/keymap.ditamap:</div>
	  <div>sag:product-shortname == <span wwpage:replace="wwvars:sag:product-shortname"></span></div>
	  <div>sag:product-longname == <span wwpage:replace="wwvars:sag:product-longname"></span></div>
	  <div>versionAdd == <span wwpage:replace="wwvars:versionAdd"></span></div>
	  <div>yearFYLY == <span wwpage:replace="wwvars:yearFYLY"></span></div>
	  <div>fingerprint == <span wwpage:replace="wwvars:fingerprint"></span></div>
	  <div>sag:CopyrightDeclaration == <span wwpage:replace="wwvars:sag:CopyrightDeclaration"></span></div>
	  <div>pdfReleaseDate == <span wwpage:replace="wwvars:pdfReleaseDate"></span></div>
	  <div>documentID == <span wwpage:replace="wwvars:documentID"></span></div>
	  <br></br>
	  <div style="text-decoration: underline">Reserve:</div>
	  <div>organization == <span wwpage:content="organization"></span></div>
	  <div>product-name == <span wwpage:content="product-name"></span></div>
	  <div>copyright-first == <span wwpage:content="copyright-first"></span></div>
	  <div>copyright-last == <span wwpage:content="copyright-last"></span></div>
	  <div>copyright-first-b == <span wwpage:content="wwvars:copyright-first-b"></span></div>
	  <div>copyright-last-b == <span wwpage:content="copyright-last-b"></span></div>
	  <div>doc-id-one == <span wwpage:content="doc-id-one"></span></div>
	  <div>doc-id-two == <span wwpage:content="doc-id-two"></span></div>  
	  <div>Published == <span wwpage:content="pub-date"></span></div>
	  --></footer></body></html>